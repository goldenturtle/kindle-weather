name: Update Smart Dashboard

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  render_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          npm install puppeteer rss-parser
          sudo apt-get update
          sudo apt-get install -y fonts-noto fonts-noto-core fonts-noto-ui-core fonts-lohit-deva imagemagick

      - name: Generate Dashboard Image
        env:
          API_KEY: ${{ secrets.WEATHER_API_KEY }}
          CITY_NAME: ${{ secrets.CITY }}
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          const Parser = require('rss-parser');
          const path = require('path');
          const https = require('https');

          (async () => {
            try {
              // 1. FETCH WEATHER
              const city = process.env.CITY_NAME || 'Mumbai';
              const key = process.env.API_KEY;
              if (!key) { console.error('KEY MISSING'); process.exit(1); }
              
              console.log('Fetching Weather...');
              const weatherUrl = \`https://api.weatherapi.com/v1/forecast.json?key=\${key}&q=\${city}&days=3&aqi=yes&lang=hi\`;
              const weatherData = await new Promise((resolve, reject) => {
                https.get(weatherUrl, (res) => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });

              // 2. FETCH NEWS (Google News Hindi)
              console.log('Fetching News...');
              const parser = new Parser();
              const newsFeed = await parser.parseURL('https://news.google.com/rss?hl=hi&gl=IN&ceid=IN:hi');
              const topHeadlines = newsFeed.items.slice(0, 5).map(item => item.title);

              // 3. FETCH QUOTE (Quotable API)
              console.log('Fetching Quote...');
              const quoteData = await new Promise((resolve) => {
                https.get('https://api.quotable.io/random?maxLength=60', (res) => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => {
                     try { resolve(JSON.parse(data)); } catch { resolve({content: 'Keep pushing forward.', author: 'Unknown'}); }
                  });
                }).on('error', () => resolve({content: 'Make today count.', author: 'Unknown'}));
              });

              // 4. COMBINE DATA
              const finalData = {
                weather: weatherData,
                news: topHeadlines,
                quote: quoteData
              };

              // 5. RENDER
              const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox'], headless: 'new'});
              const page = await browser.newPage();
              await page.setViewport({ width: 758, height: 1024, deviceScaleFactor: 1 });

              await page.evaluateOnNewDocument((data) => { window.injectedData = data; }, finalData);
              
              const htmlPath = path.resolve(process.env.GITHUB_WORKSPACE, 'weather.html');
              await page.goto('file://' + htmlPath, { waitUntil: 'networkidle0' });
              
              await page.screenshot({ path: 'weather.png' });
              await browser.close();

            } catch (e) { console.error(e); process.exit(1); }
          })();
          "

      - name: Convert to Kindle Grayscale
        run: |
          convert weather.png -resize 758x1024\! -background white -gravity center -extent 758x1024 -colorspace Gray -depth 8 -type Grayscale weather-gray.png

      - name: Save Image to GitHub
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add weather-gray.png
          git commit -m "Update dashboard" || echo "No changes"
          git push
