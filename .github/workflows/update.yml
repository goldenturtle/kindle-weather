name: Update Weather Dashboard

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  render_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          npm install puppeteer
          sudo apt-get update
          # Install Hindi fonts + ImageMagick
          sudo apt-get install -y fonts-noto fonts-noto-core fonts-noto-ui-core fonts-lohit-deva imagemagick

      - name: Generate Dashboard Image
        env:
          API_KEY: ${{ secrets.WEATHER_API_KEY }}
          CITY_NAME: ${{ secrets.CITY }}
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          const path = require('path');
          const https = require('https');

          (async () => {
            try {
              // 1. Fetch Data
              const city = process.env.CITY_NAME || 'Mumbai';
              const key = process.env.API_KEY;
              if (!key) { console.error('KEY MISSING'); process.exit(1); }
              const url = \`https://api.weatherapi.com/v1/forecast.json?key=\${key}&q=\${city}&days=3&aqi=yes&lang=hi\`;

              console.log('Fetching...');
              const weatherData = await new Promise((resolve, reject) => {
                https.get(url, (res) => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });

              const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox'], headless: 'new'});
              const page = await browser.newPage();
              
              // === CRITICAL: PAPERWHITE RESOLUTION ===
              await page.setViewport({ width: 758, height: 1024, deviceScaleFactor: 1 });

              // Inject Data
              await page.evaluateOnNewDocument((data) => { window.injectedData = data; }, weatherData);
              
              // Load File
              const htmlPath = path.resolve(process.env.GITHUB_WORKSPACE, 'weather.html');
              await page.goto('file://' + htmlPath, { waitUntil: 'networkidle0' });
              
              // Screenshot
              await page.screenshot({ path: 'weather.png' });
              await browser.close();
            } catch (e) { console.error(e); process.exit(1); }
          })();
          "

      - name: Convert to Kindle Grayscale
        run: |
          # Force the image to be exactly 758x1024 (Paperwhite Size)
          # The \! tells it to force the size even if aspect ratio is different
          convert weather.png -resize 758x1024\! -background white -gravity center -extent 758x1024 -colorspace Gray -depth 8 -type Grayscale weather-gray.png

      - name: Save Image to GitHub
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add weather-gray.png
          git commit -m "Update dashboard" || echo "No changes"
          git push
