name: Update Weather Dashboard

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  render_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies
        # We install Puppeteer to "browse" your HTML file
        run: npm install puppeteer

      - name: Generate Dashboard Image
        env:
          # This pulls the keys from the "Secrets" vault we set up earlier
          API_KEY: ${{ secrets.WEATHER_API_KEY }}
          CITY_NAME: ${{ secrets.CITY }}
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const https = require('https');

          (async () => {
            try {
              // 1. Fetch Data Manually (No external fetch lib needed)
              const city = process.env.CITY_NAME || 'Mumbai';
              const key = process.env.API_KEY;
              if (!key) { console.error('API KEY MISSING!'); process.exit(1); }
              
              const url = \`https://api.weatherapi.com/v1/forecast.json?key=\${key}&q=\${city}&days=3&aqi=yes\`;
              
              console.log('Fetching weather for:', city);
              
              const weatherData = await new Promise((resolve, reject) => {
                https.get(url, (res) => {
                  let data = '';
                  res.on('data', (chunk) => data += chunk);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });

              if (weatherData.error) {
                 console.error('API Error:', weatherData.error.message);
                 process.exit(1);
              }

              // 2. Launch Browser (Safety Sandbox Enabled)
              const browser = await puppeteer.launch({
                args: ['--no-sandbox', '--disable-setuid-sandbox'],
                headless: 'new'
              });
              const page = await browser.newPage();
              await page.setViewport({ width: 600, height: 800 });

              // 3. Inject Data
              // We put the data into the page before it even loads
              await page.evaluateOnNewDocument((data) => {
                window.injectedData = data;
              }, weatherData);

              // 4. Load your local HTML file
              // This finds 'weather.html' in the main folder
              const htmlPath = path.resolve(process.env.GITHUB_WORKSPACE, 'weather.html');
              const fileUrl = 'file://' + htmlPath;
              console.log('Loading File:', fileUrl);
              
              await page.goto(fileUrl, { waitUntil: 'networkidle0' });

              // 5. Screenshot
              await page.screenshot({ path: 'weather.png' });
              await browser.close();
              
            } catch (error) {
              console.error('Script Failed:', error);
              process.exit(1);
            }
          })();
          "

      - name: Convert to Kindle Grayscale
        run: |
          sudo apt-get install -y imagemagick
          # Convert to 8-bit grayscale (Fixes black bar issue)
          convert weather.png -colorspace Gray -depth 8 -type Grayscale weather-gray.png

      - name: Save Image to GitHub
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add weather-gray.png
          git commit -m "Update dashboard image" || echo "No changes"
          git push
