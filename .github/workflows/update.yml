name: Update Weather Dashboard

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:      # Allows manual trigger

permissions:
  contents: write

jobs:
  render_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies & Hindi Fonts
        run: |
          npm install puppeteer
          # === THIS FIXES THE SQUARES ===
          sudo apt-get update
          sudo apt-get install -y fonts-noto fonts-noto-core fonts-noto-ui-core fonts-lohit-deva

      - name: Generate Dashboard Image
        env:
          API_KEY: ${{ secrets.WEATHER_API_KEY }}
          CITY_NAME: ${{ secrets.CITY }}
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const https = require('https');

          (async () => {
            try {
              // 1. Fetch Data
              const city = process.env.CITY_NAME || 'Mumbai';
              const key = process.env.API_KEY;
              if (!key) { console.error('KEY MISSING'); process.exit(1); }
              
              const url = \`https://api.weatherapi.com/v1/forecast.json?key=\${key}&q=\${city}&days=3&aqi=yes&lang=hi\`;
              // Added &lang=hi to get Hindi condition text from API!

              console.log('Fetching...');
              const weatherData = await new Promise((resolve, reject) => {
                https.get(url, (res) => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                }).on('error', reject);
              });

              // 2. Launch Browser
              const browser = await puppeteer.launch({
                args: ['--no-sandbox', '--disable-setuid-sandbox'],
                headless: 'new'
              });
              const page = await browser.newPage();
              // EXACT Kindle Resolution
              await page.setViewport({ width: 600, height: 800, deviceScaleFactor: 1 });

              // 3. Inject Data
              await page.evaluateOnNewDocument((data) => {
                window.injectedData = data;
              }, weatherData);

              // 4. Load File
              const htmlPath = path.resolve(process.env.GITHUB_WORKSPACE, 'weather.html');
              await page.goto('file://' + htmlPath, { waitUntil: 'networkidle0' });

              // 5. Screenshot
              await page.screenshot({ path: 'weather.png' });
              await browser.close();
            } catch (e) {
              console.error(e); process.exit(1);
            }
          })();
          "

      - name: Convert to Kindle Grayscale
        run: |
          sudo apt-get install -y imagemagick
          # Resize/Extent ensures it is ALWAYS 600x800 white background
          convert weather.png -resize 600x800 -background white -gravity center -extent 600x800 -colorspace Gray -depth 8 -type Grayscale weather-gray.png

      - name: Save Image to GitHub
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add weather-gray.png
          git commit -m "Update dashboard image" || echo "No changes"
          git push
